
ssh -L 5678:localhost:5678 slurm

#workflow for co-assembly of metagenomes using SPAdes and annotation using Anvio
conda activate /apps/anvio/7

#Set up the path to the working directory
WORKDIR=/proj/DECOMB/analysis/metaG_anvio/
cd $WORKDIR

#export sequences from bam files, run QC and trim adapters
sbatch -a 105352-105354 ../DECOMB/metaG/process_raw_sequences.sh

#run co-assembly and produce statistics on it
sbatch ../DECOMB/metaG/co_assembly_spades.sh

#map reads from each library on the co-assembly
sbatch ../DECOMB/metaG/map_reads_bbmap_spades.sh

#import to anvio and annotate the metagenome
sbatch ../DECOMB/metaG/anvio-annotation.sh


#add KEGG annotation to genes (according to https://merenlab.org/2018/01/17/importing-ghostkoala-annotations/)
sed 's/>/>genecall_/' 05_ANVIO/$WORKDIR/05_ANVIO/spades-AA-sequences.fa > 05_ANVIO/$WORKDIR/05_ANVIO/spades-AA-sequences_GhostKOALA.fa

#manually upload the output to GhostKOALA 
#download the output files user_ko.txt and user.out.top.gz to 05_ANVIO

#download and parse the KEGG database orthologies 
wget 'https://www.genome.jp/kegg-bin/download_htext?htext=ko00001&format=htext&filedir=' -O ko00001.keg

cd 05_ANVIO

kegfile="ko00001.keg"

while read -r prefix content
do
    case "$prefix" in A) col1="$content";; \
                      B) col2="$content" ;; \
                      C) col3="$content";; \
                      D) echo -e "$col1\t$col2\t$col3\t$content";;
    esac 
done < <(sed '/^[#!+]/d;s/<[^>]*>//g;s/^./& /' < "$kegfile") > KO_Orthology_ko00001.txt

cd ..

#parse GhostKoala results
python /proj/DECOMB/source/GhostKoalaParser/KEGG-to-anvio --KeggDB 05_ANVIO/KO_Orthology_ko00001.txt -i 05_ANVIO/user_ko.txt -o 05_ANVIO/KeggAnnotations-AnviImportable.txt

#import annotation to ANVIO
anvi-import-functions -c 05_ANVIO/spades.db -i 05_ANVIO/KeggAnnotations-AnviImportable.txt


################################
#export data for metaP reference
################################

sed -n '2,$p' 05_ANVIO/spades-gene-calls.txt | sort -n -k 1 > 05_ANVIO/spades-gene-calls-sorted.txt

#export functions of each gene

DATABASES=("COG20_FUNCTION" "KeggGhostKoala" "Pfam"  "GO" "InterPro" "Hamap")

for db in ${DATABASES[@]}; do
anvi-export-functions -c 05_ANVIO/spades.db --annotation-sources $db -o 05_ANVIO/spades-$db-functions.txt

#remove spaces
sed -e 's/ /_/g' 05_ANVIO/spades-$db-functions.txt > 05_ANVIO/spades-$db-functions-corrected.txt

#sort the table
sed -n '2,$p' 05_ANVIO/spades-$db-functions-corrected.txt | sort -n -k 1 > 05_ANVIO/spades-$db-functions-sorted.txt
done

#export taxonomy of each gene
anvi-export-table --table genes_taxonomy -o spades-genes-taxonomy.txt spades.db

#export taxonomy table
anvi-export-table --table taxon_names -o spades-tax-names.txt spades.db

#merge all data together
("COG20_FUNCTION" "KeggGhostKoala" "Pfam"  "GO" "InterPro" "Hamap")

join -11 -a1 --header 05_ANVIO/spades-gene-calls-sorted.txt 05_ANVIO/spades-COG20_FUNCTION-functions-sorted.txt > 05_ANVIO/spades-COG20_FUNCTION-merged.txt

join -11 -a1 --header 05_ANVIO/spades-COG20_FUNCTION-merged.txt 05_ANVIO/spades-KeggGhostKoala-functions-sorted.txt > 05_ANVIO/spades-KeggGhostKoala-merged.txt

join -11 -a1 --header 05_ANVIO/spades-KeggGhostKoala-merged.txt 05_ANVIO/spades-Pfam-functions-sorted.txt > 05_ANVIO/spades-Pfam-merged.txt

join -11 -a1 --header 05_ANVIO/spades-Pfam-merged.txt 05_ANVIO/spades-GO-functions-sorted.txt > 05_ANVIO/spades-GO-merged.txt

join -11 -a1 --header 05_ANVIO/spades-GO-merged.txt 05_ANVIO/spades-InterPro-functions-sorted.txt > 05_ANVIO/spades-InterPro-merged.txt

join -11 -a1 --header 05_ANVIO/spades-InterPro-merged.txt 05_ANVIO/spades-Hamap-functions-sorted.txt > 05_ANVIO/spades-Hamap-merged.txt

################################
#Produce bins
################################

mkdir 06_BINS

sbatch ../DECOMB/metaG/bin_co-assembly.sh

#explore bins of CONCOCT (they were better than the ones got out of metabat)
anvi-interactive -p $WORKDIR/05_ANVIO/SPAdes/merged_profile/PROFILE.db -c $WORKDIR/05_ANVIO/spades.db -C CONCOCT --server-only -P 5678

#refine selected bins

#Bin 84
#in the following step part of the contigs were removed due to coverage differences
#the removed conitgs had no taxonomic assignment
#Bin_84_1 - Pseudoalteromonas phenolica - length 3.92Mbp (C93/R0). 

anvi-refine -p $WORKDIR/05_ANVIO/SPAdes/merged_profile/PROFILE.db -c $WORKDIR/05_ANVIO/spades.db -C CONCOCT -b Bin_84 --server-only -P 5678

#Bin 115
#Based on coverage, the bin was split into two sub bins and part of the sequences were discarded.
#Bin_115_1 - Bermanella sp002683575 (Pseudomonadales) - length 4.86Mbp (C98.6/R0)
#Bin_115_2 - Glaciecola sp000155775 (Enterobacterales) - length 2.22Mbp (C100/R0)

anvi-refine -p $WORKDIR/05_ANVIO/SPAdes/merged_profile/PROFILE.db -c $WORKDIR/05_ANVIO/spades.db -C CONCOCT -b Bin_115 --server-only -P 5678

#Bin 76
#Based on coverage large part of the bin was discarded.
#Bin_76_1 - Marinobacterium jannaschii (weak taxonomy, but for sure family Nitrincolaceae) - length 3.78Mbp (C100/R0)
anvi-refine -p $WORKDIR/05_ANVIO/SPAdes/merged_profile/PROFILE.db -c $WORKDIR/05_ANVIO/spades.db -C CONCOCT -b Bin_76 --server-only -P 5678

#Bin 179
#Based on coverage large part of the bin was discarded, however the remained bin also varies in coverage
#Bin_179_1 - family Cellvibrionaceae - length 3.18Mbp (C93/R2.8)
anvi-refine -p $WORKDIR/05_ANVIO/SPAdes/merged_profile/PROFILE.db -c $WORKDIR/05_ANVIO/spades.db -C CONCOCT -b Bin_179 --server-only -P 5678

#Bin 38
#Based on coverage large part of the bin was discarded, however the remained bin also varies in coverage
#Bin_38_1 - Vibrio - length 1.7Mbp (C83/R0)
anvi-refine -p $WORKDIR/05_ANVIO/SPAdes/merged_profile/PROFILE.db -c $WORKDIR/05_ANVIO/spades.db -C CONCOCT -b Bin_38 --server-only -P 5678

#Bin 5
#Based on coverage large part of the bin was discarded, however the remained bin also varies in coverage
#Bin_5_1 - Alteromonas - length 4.63Mbp (C59.2/R1.4)
#Bin_5_2 - family Nitrincolaceae - length 5.19Mbp (C100/R0)
#Bin_5_3 - Reinekea blandensis (Pseudomonadales) - length 4.08Mbp (C100/R2.8)
#Bin_5_4 - Pseudoalteromonas - length 4.87Mbp (C42.3/R0)
anvi-refine -p $WORKDIR/05_ANVIO/SPAdes/merged_profile/PROFILE.db -c $WORKDIR/05_ANVIO/spades.db -C CONCOCT -b Bin_5 --server-only -P 5678

#Bin 2
#The bin was split into two separated bins of Alteromonas
#Bin_2_1 - Alteromonas - length 3.7Mbp (C78.9/R0)
#Bin_2_2 - Alteromonas - length 5.19Mbp (C80.3/R0)
anvi-refine -p $WORKDIR/05_ANVIO/SPAdes/merged_profile/PROFILE.db -c $WORKDIR/05_ANVIO/spades.db -C CONCOCT -b Bin_2 --server-only -P 5678

#Bin 150
#The bin was refined twice to reduce redundancy
#Bin_150_1_1 - Rhodobacteraceae - length 2.6Mbp (C97.2/R1.4)
anvi-refine -p $WORKDIR/05_ANVIO/SPAdes/merged_profile/PROFILE.db -c $WORKDIR/05_ANVIO/spades.db -C CONCOCT -b Bin_150 --server-only -P 5678

#summarzed refined bins
sbatch ../DECOMB/metaG/sum_refined_bins.sh




########################################################
#draft loop
#######################
cp 05_ANVIO/spades-gene-calls-sorted.txt 05_ANVIO/spades-genes.txt

for db in ${DATABASES[@]}; do
join -11 -a1 --header 05_ANVIO/spades-genes.txt 05_ANVIO/spades-$db-functions-sorted.txt > 05_ANVIO/spades-genes-$db-merged.txt

mv 05_ANVIO/spades-genes-$db-merged.txt 05_ANVIO/spades-genes.txt
done

#generate AAs fasta file
awk '{print ">"$1"_"$2"_"$12"_"$16"\n"$10}' 05_ANVIO/spades-genes-functions-merged.txt > 05_ANVIO/spades-AAs-ref-db.fasta
