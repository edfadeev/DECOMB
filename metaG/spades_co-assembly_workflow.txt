#workflow for co-assembly of metagenomes using SPAdes and annotation using Anvio


conda activate /apps/anvio/7

#Set up the path to the working directory
WORKDIR=/proj/DECOMB/analysis/metaG_anvio/
cd $WORKDIR

#export sequences from bam files, run QC and trim adapters
sbatch -a 105352-105354 ../DECOMB/metaG/process_raw_sequences.sh

#run co-assembly and produce statistics on it
sbatch ../DECOMB/metaG/co_assembly_spades.sh

#map reads from each library on the co-assembly
sbatch ../DECOMB/metaG/map_reads_bbmap_spades.sh

#import to anvio and annotate the metagenome
sbatch ../DECOMB/metaG/anvio-annotation.sh


#add KEGG annotation to genes (according to https://merenlab.org/2018/01/17/importing-ghostkoala-annotations/)
sed 's/>/>genecall_/' 05_ANVIO/$WORKDIR/05_ANVIO/spades-AA-sequences.fa > 05_ANVIO/$WORKDIR/05_ANVIO/spades-AA-sequences_GhostKOALA.fa

#manually upload the output to GhostKOALA 
#download the output files user_ko.txt and user.out.top.gz to 05_ANVIO

#download and parse the KEGG database orthologies 
wget 'https://www.genome.jp/kegg-bin/download_htext?htext=ko00001&format=htext&filedir=' -O ko00001.keg

cd 05_ANVIO

kegfile="ko00001.keg"

while read -r prefix content
do
    case "$prefix" in A) col1="$content";; \
                      B) col2="$content" ;; \
                      C) col3="$content";; \
                      D) echo -e "$col1\t$col2\t$col3\t$content";;
    esac 
done < <(sed '/^[#!+]/d;s/<[^>]*>//g;s/^./& /' < "$kegfile") > KO_Orthology_ko00001.txt

cd ..

#parse GhostKoala results
python /proj/DECOMB/source/GhostKoalaParser/KEGG-to-anvio --KeggDB 05_ANVIO/KO_Orthology_ko00001.txt -i 05_ANVIO/user_ko.txt -o 05_ANVIO/KeggAnnotations-AnviImportable.txt

#import annotation to ANVIO
anvi-import-functions -c 05_ANVIO/spades.db -i 05_ANVIO/KeggAnnotations-AnviImportable.txt


################################
#export data for metaP reference
################################
#export functions of each gene
anvi-export-functions -c 05_ANVIO/spades.db --annotation-sources COG20_FUNCTION -o 05_ANVIO/spades-COG-functions.txt

anvi-export-functions -c 05_ANVIO/spades.db --annotation-sources KeggGhostKoala -o 05_ANVIO/spades-KEGG-functions.txt

#export taxonomy of each gene
anvi-export-table --table genes_taxonomy -o spades-genes-taxonomy.txt spades.db
#export taxonomy table
anvi-export-table --table taxon_names -o spades-tax-names.txt spades.db

#remove spaces
sed -e 's/ /_/g' 05_ANVIO/spades-COG-functions.txt > 05_ANVIO/spades-COG-functions-corrected.txt
sed -e 's/ /_/g' 05_ANVIO/spades-KEGG-functions.txt > 05_ANVIO/spades-KEGG-functions-corrected.txt

#sort all tables before merging
sed -n '2,$p' 05_ANVIO/spades-gene-calls.txt | sort -n -k 1 > 05_ANVIO/spades-gene-calls-sorted.txt
sed -n '2,$p' 05_ANVIO/spades-COG-functions-corrected.txt | sort -n -k 1 > 05_ANVIO/spades-COG-functions-sorted.txt
sed -n '2,$p' 05_ANVIO/spades-KEGG-functions-corrected.txt | sort -n -k 1 > 05_ANVIO/spades-KEGG-functions-sorted.txt

#merge all data together
join -11 -a1 --header 05_ANVIO/spades-gene-calls-sorted.txt 05_ANVIO/spades-COG-functions-sorted.txt > 05_ANVIO/spades-genes-COG-merged.txt

join -11 -a1 --header 05_ANVIO/spades-genes-COG-merged.txt 05_ANVIO/spades-KEGG-functions-sorted.txt > 05_ANVIO/spades-genes-functions-merged.txt

#generate AAs fasta file
awk '{print ">"$1"_"$2"_"$12"_"$16"\n"$10}' 05_ANVIO/spades-genes-functions-merged.txt > 05_ANVIO/spades-AAs-ref-db.fasta
